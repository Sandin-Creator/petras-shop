<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="title">Petras Shop</title>

  <!-- Styles -->
  <link rel="stylesheet" href="/css/theme.css">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/layout.css">
  <link rel="stylesheet" href="/css/forms-and-filters.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/product.css">
  <link rel="stylesheet" href="/css/modal.css">
  <link rel="stylesheet" href="/css/admin.css">
  <link rel="stylesheet" href="/css/utilities.css">
  <link rel="stylesheet" href="/css/mobile.css">
  <meta name="color-scheme" content="light dark">
</head>

<body>
  <a class="sr-only sr-only-focusable" href="#main" data-i18n="skip">Skip to content</a>

  <!-- Header -->
  <header class="site-header" role="banner">
    <div class="container header-content">
      <h1 class="site-title" data-i18n="title">Petras Shop</h1>

      <!-- Desktop nav -->
      <nav class="site-nav desktop-only" aria-label="Primary">
        <div id="langFlags" class="lang-flags" aria-label="Language">
          <button type="button" class="lang-flag" data-lang="en" aria-label="English">
            <img src="/assets/flags/en.png" alt="English">
          </button>
          <button type="button" class="lang-flag" data-lang="sv" aria-label="Svenska">
            <img src="/assets/flags/sv.png" alt="Svenska">
          </button>
          <button type="button" class="lang-flag" data-lang="fi" aria-label="Suomi">
            <img src="/assets/flags/fi.png" alt="Suomi">
          </button>
        </div>
      </nav>

      <!-- Mobile menu -->
      <details class="mnav mobile-only">
        <summary class="nav-link" aria-label="Menu">â˜°</summary>
        <nav class="site-nav" aria-label="Primary">
          <div id="langFlagsMobile" class="lang-flags" aria-label="Language">
            <button type="button" class="lang-flag" data-lang="en" aria-label="English">
              <img src="/assets/flags/en.png" alt="English">
            </button>
            <button type="button" class="lang-flag" data-lang="sv" aria-label="Svenska">
              <img src="/assets/flags/sv.png" alt="Svenska">
            </button>
            <button type="button" class="lang-flag" data-lang="fi" aria-label="Suomi">
              <img src="/assets/flags/fi.png" alt="Suomi">
            </button>
          </div>
        </nav>
      </details>

      <!-- Theme toggle -->
      <button id="themeToggle" class="theme-toggle" aria-pressed="false" title="Toggle theme">ðŸŒ™</button>
    </div>
  </header>

  <!-- Hero -->
  <section class="container" aria-labelledby="hero-title">
    <div class="hero card">
      <h2 id="hero-title" data-i18n="heroTitle">Blooming new arrivals</h2>
      <p data-i18n="heroDesc">Soft tones, comfy cuts, and everyday essentials.</p>
      <a href="#grid" class="btn btn-accent" data-i18n="shopNow">Shop now</a>
    </div>
  </section>

  <!-- Main -->
  <main id="main" class="container" role="main">
    <!-- Filters -->
    <form class="filters" role="search" aria-label="Product filters" onsubmit="return false">
      <label class="sr-only" for="q" data-i18n="search">Search products</label>
      <input
        id="q"
        name="q"
        type="text"
        class="filter-input"
        placeholder="Search..."
        data-i18n="search"
        data-i18n-attr="placeholder"
        autocomplete="off"
        inputmode="search"
      />

      <label class="sr-only" for="category" data-i18n="category">Category</label>
      <select id="category" name="category" class="filter-select" aria-label="Category">
        <option value="" data-i18n="allCategories">All categories</option>
        <option value="clothes" data-i18n="catClothes">Clothes</option>
        <option value="shoes" data-i18n="catShoes">Shoes</option>
        <option value="accessories" data-i18n="catAccessories">Accessories</option>
        <option value="electronics" data-i18n="catElectronics">Electronics</option>
        <option value="perfume" data-i18n="catPerfume">Perfume</option>
        <option value="cosmetics" data-i18n="catCosmetics">Cosmetics</option>
      </select>

      <label class="sr-only" for="min" data-i18n="minPrice">Minimum price</label>
      <input
        id="min"
        name="min"
        type="number"
        class="filter-input"
        placeholder="Min â‚¬"
        data-i18n="minPrice"
        data-i18n-attr="placeholder"
        inputmode="decimal"
        min="0"
        step="0.01"
      />

      <label class="sr-only" for="max" data-i18n="maxPrice">Maximum price</label>
      <input
        id="max"
        name="max"
        type="number"
        class="filter-input"
        placeholder="Max â‚¬"
        data-i18n="maxPrice"
        data-i18n-attr="placeholder"
        inputmode="decimal"
        min="0"
        step="0.01"
      />

      <label class="sr-only" for="sort" data-i18n="sort">Sort</label>
      <select id="sort" name="sort" class="filter-select" aria-label="Sort">
        <option value="new" data-i18n="sortNewest">Newest</option>
        <option value="price-asc" data-i18n="sortAsc">Price â†‘</option>
        <option value="price-desc" data-i18n="sortDesc">Price â†“</option>
        <option value="discount-desc" data-i18n="sortDiscount">Biggest discount</option>
      </select>

      <!-- Toggles -->
      <label class="checkbox-inline">
        <input type="checkbox" id="onlySale" />
        <span data-i18n="onlySale">On sale</span>
      </label>

      <label class="checkbox-inline">
        <input type="checkbox" id="inStock" />
        <span data-i18n="inStock">In stock only</span>
      </label>

      <!-- View density + Reset -->
      <button id="densityToggle" type="button" class="btn" title="Toggle compact view" data-i18n="compact">
        Compact view
      </button>
      <button id="clearFilters" type="button" class="btn" data-i18n="clear">
        Clear all
      </button>
    </form>

    <!-- Results meta -->
    <p id="results-meta" class="price" aria-live="polite" aria-atomic="true" data-i18n="loading">
      Loading productsâ€¦
    </p>

    <!-- Active filter chips -->
    <div id="active-filters" class="active-filters" aria-live="polite" aria-atomic="true"></div>

    <!-- Product grid -->
    <section id="grid" class="product-grid" aria-label="Products"></section>

    <div id="load-more-wrap" class="center">
      <button id="loadMore" class="btn" data-i18n="loadMore">Load more</button>
    </div>

    <!-- Empty state -->
    <template id="empty-state">
      <div class="card">
        <h4 data-i18n="noResults">No results</h4>
        <p class="price" data-i18n="tryAdjust">Try adjusting filters or clearing your search.</p>
      </div>
    </template>

    <!-- Product card template -->
    <template id="product-card">
      <article class="card" data-badge="">
        <img alt="" />
        <h4></h4>
        <p class="price"></p>
        <a class="btn" data-i18n="view">View</a>
      </article>
    </template>
  </main>

  <!-- No-JS notice -->
  <noscript>
    <div class="container">
      <p data-i18n="enableJs">Please enable JavaScript to browse products.</p>
    </div>
  </noscript>

  <!-- Quick View Modal -->
  <div id="quickview" class="modal" hidden aria-hidden="true">
    <div class="modal-backdrop" data-close></div>
    <div class="modal-dialog card" role="dialog" aria-modal="true" aria-labelledby="qv-title">
      <button class="modal-close btn" type="button" data-close aria-label="Close">Ã—</button>
      <div id="qv-body">
        <p class="price" data-i18n="loading">Loadingâ€¦</p>
      </div>
    </div>
  </div>

  <!-- Admin link injection -->
  <script>
    (async () => {
      try {
        const res = await fetch("/api/auth/me", { credentials: "include" });
        const data = await res.json();
        if (data?.user?.role === "ADMIN") {
          document.querySelectorAll(".site-nav").forEach(nav => {
            const a = document.createElement("a");
            a.href = "/admin";
            a.className = "nav-link";
            a.dataset.i18n = "admin";
            a.textContent = "Admin";
            nav.appendChild(a);
          });
        }
      } catch {}
    })();
  </script>

  <!-- App scripts -->
  <script type="module" src="/js/storefront/main.js"></script>
  <script src="/js/quickview.js" defer></script>
  <script type="module">
    import { initLang } from "/js/i18n.js";
    initLang();
  </script>
  <script src="/js/theme.js" defer></script>

  <!-- Flag language picker wiring -->
  <script>
  (function(){
    const blocks = [
      document.getElementById('langFlags'),
      document.getElementById('langFlagsMobile')
    ].filter(Boolean);
    if (blocks.length === 0) return;

    const STORAGE_KEY = 'lang';
    const params = new URLSearchParams(location.search);
    const currentLang = params.get('lang') || localStorage.getItem(STORAGE_KEY) || 'en';

    function markActive(code){
      blocks.forEach(b=>{
        b.querySelectorAll('.lang-flag').forEach(btn=>{
          btn.classList.toggle('active', btn.dataset.lang === code);
        });
      });
    }

    function applyLang(code){
      if (typeof window.changeLanguage === 'function') {
        window.changeLanguage(code);
        try{ localStorage.setItem(STORAGE_KEY, code); }catch(e){}
        markActive(code);
        return;
      }
      try{ localStorage.setItem(STORAGE_KEY, code); }catch(e){}
      const p = new URLSearchParams(location.search);
      p.set('lang', code);
      location.search = p.toString();
    }

    blocks.forEach(b=>{
      b.addEventListener('click', (e)=>{
        const btn = e.target.closest('.lang-flag');
        if (!btn) return;
        applyLang(btn.dataset.lang);
      });
    });

    markActive(currentLang);
  })();
  </script>
</body>
</html>
